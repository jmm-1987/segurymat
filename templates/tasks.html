{% extends "base.html" %}

{% block title %}Tareas - Agenda Telegram{% endblock %}

{% block content %}
<div class="filters">
    <form method="GET" action="{{ url_for('tasks') }}" id="filterForm" class="filter-form">
        <!-- Logo con contenedor redondo a la izquierda -->
        <div class="logo-container">
            <img src="{{ url_for('static', filename='logoagenda.png') }}" alt="Logo" class="logo-img">
        </div>
        <!-- Men√∫ circular tipo dock -->
        <div class="dock-container">
            <!-- Vista -->
            <div class="dock-item" data-filter="view_mode">
              <button type="button" class="dock-button" onclick="toggleDockMenu(this)" title="Vista">
                <span class="dock-icon">üìã</span>
                <span class="dock-tooltip">Vista</span>
              </button>
              <div class="dock-menu">
                <div class="dock-menu-content">
                  <label class="dock-option">
                    <input type="radio" name="view_mode" value="list" {% if view_mode != 'calendar' %}checked{% endif %} onchange="changeView('list')">
                    <span>üìã Lista</span>
                  </label>
                  <label class="dock-option">
                    <input type="radio" name="view_mode" value="calendar" {% if view_mode == 'calendar' %}checked{% endif %} onchange="changeView('calendar')">
                    <span>üìÖ Semana</span>
                  </label>
                </div>
              </div>
            </div>
          
            <!-- Estado -->
            <div class="dock-item" data-filter="status">
              <button type="button" class="dock-button" onclick="toggleDockMenu(this)" title="Estado">
                <span class="dock-icon">üìä</span>
                <span class="dock-tooltip">Estado</span>
              </button>
              <div class="dock-menu">
                <div class="dock-menu-content">
                  <label class="dock-option">
                    <input type="radio" name="status" value="all" {% if current_status == 'all' %}checked{% endif %}>
                    <span>üìä Todos</span>
                  </label>
                  <label class="dock-option">
                    <input type="radio" name="status" value="open" {% if current_status == 'open' or current_status == '' %}checked{% endif %}>
                    <span>üü¶ Abiertas</span>
                  </label>
                  <label class="dock-option">
                    <input type="radio" name="status" value="completed" {% if current_status == 'completed' %}checked{% endif %}>
                    <span>‚úÖ Completadas</span>
                  </label>
                  <label class="dock-option">
                    <input type="radio" name="status" value="cancelled" {% if current_status == 'cancelled' %}checked{% endif %}>
                    <span>‚ùå Canceladas</span>
                  </label>
                </div>
              </div>
            </div>
          
            <!-- Prioridad -->
            <div class="dock-item" data-filter="priority">
              <button type="button" class="dock-button" onclick="toggleDockMenu(this)" title="Prioridad">
                <span class="dock-icon">‚ö°</span>
                <span class="dock-tooltip">Prioridad</span>
              </button>
              <div class="dock-menu">
                <div class="dock-menu-content">
                  <label class="dock-option">
                    <input type="radio" name="priority" value="all" {% if current_priority == 'all' %}checked{% endif %}>
                    <span>‚ö° Todas</span>
                  </label>
                  <label class="dock-option">
                    <input type="radio" name="priority" value="urgent" {% if current_priority == 'urgent' %}checked{% endif %}>
                    <span>üî¥ Urgente</span>
                  </label>
                  <label class="dock-option">
                    <input type="radio" name="priority" value="normal" {% if current_priority == 'normal' %}checked{% endif %}>
                    <span>üü° Normal</span>
                  </label>
                </div>
              </div>
            </div>
          
            <!-- Usuario -->
            <div class="dock-item" data-filter="user_id">
              <button type="button" class="dock-button" onclick="toggleDockMenu(this)" title="Usuario">
                <span class="dock-icon">üë§</span>
                <span class="dock-tooltip">Usuario</span>
              </button>
              <div class="dock-menu">
                <div class="dock-menu-content">
                  <label class="dock-option">
                    <input type="radio" name="user_id" value="" {% if not current_user_id %}checked{% endif %}>
                    <span>üë§ Todos</span>
                  </label>
                  {% for uid, uname in users.items() %}
                  <label class="dock-option">
                    <input type="radio" name="user_id" value="{{ uid }}" {% if current_user_id == uid %}checked{% endif %}>
                    <span>{{ uname }}</span>
                  </label>
                  {% endfor %}
                </div>
              </div>
            </div>
          
            <!-- Fecha -->
            <div class="dock-item" data-filter="task_date">
              <button type="button" class="dock-button" onclick="toggleDockMenu(this)" title="Fecha">
                <span class="dock-icon">üìÖ</span>
                <span class="dock-tooltip">Fecha</span>
              </button>
              <div class="dock-menu">
                <div class="dock-menu-content">
                  <input type="date" name="task_date" value="{{ current_task_date }}" class="dock-date-input" placeholder="Fecha">
                </div>
              </div>
            </div>
          
            <!-- Categor√≠a -->
            <div class="dock-item" data-filter="category">
              <button type="button" class="dock-button" onclick="toggleDockMenu(this)" title="Categor√≠a">
                <span class="dock-icon">üìÇ</span>
                <span class="dock-tooltip">Categor√≠a</span>
              </button>
              <div class="dock-menu">
                <div class="dock-menu-content">
                  <label class="dock-option">
                    <input type="radio" name="category" value="all" {% if current_category == 'all' or not current_category %}checked{% endif %}>
                    <span>üìÇ Todas</span>
                  </label>
                  {% for cat in categories %}
                  <label class="dock-option">
                    <input type="radio" name="category" value="{{ cat.name }}" {% if current_category == cat.name %}checked{% endif %}>
                    <span style="color: {{ cat.color }};">{{ cat.icon }} {{ cat.display_name or cat.name }}</span>
                  </label>
                  {% endfor %}
                </div>
              </div>
            </div>
          
            <!-- Editar Categor√≠as -->
            <div class="dock-item dock-action">
              <a href="{{ url_for('categories') }}" class="dock-button dock-button-settings" title="Editar categor√≠as">
                <span class="dock-icon">‚öôÔ∏è</span>
                <span class="dock-tooltip">Editar categor√≠as</span>
              </a>
            </div>
          
            <!-- B√∫squeda -->
            <div class="dock-item" data-filter="search">
              <button type="button" class="dock-button" onclick="toggleDockMenu(this)" title="Buscar">
                <span class="dock-icon">üîç</span>
                <span class="dock-tooltip">Buscar</span>
              </button>
              <div class="dock-menu">
                <div class="dock-menu-content">
                  <input type="text" name="search" value="{{ current_search or '' }}" class="dock-search-input" placeholder="Buscar...">
                </div>
              </div>
            </div>
          
            <!-- Filtrar -->
            <div class="dock-item dock-action">
              <button type="submit" class="dock-button dock-button-primary" title="Filtrar">
                <span class="dock-icon">‚úì</span>
                <span class="dock-tooltip">Filtrar</span>
              </button>
            </div>
          
            <!-- Limpiar -->
            <div class="dock-item dock-action">
              <a href="{{ url_for('tasks') }}" class="dock-button dock-button-secondary" title="Limpiar">
                <span class="dock-icon">üîÑ</span>
                <span class="dock-tooltip">Limpiar</span>
              </a>
            </div>
          
            <!-- Logout -->
            <div class="dock-item dock-action">
              <a href="{{ url_for('logout') }}" class="dock-button dock-button-danger" title="Cerrar sesi√≥n">
                <span class="dock-icon">‚úï</span>
                <span class="dock-tooltip">Cerrar sesi√≥n</span>
              </a>
            </div>
          </div>
          
    </form>
</div>

<div class="tasks-list">
    <!-- Slider para tareas sin fecha (siempre visible) -->
    {% if tasks_without_date %}
    <div class="no-date-section" style="margin-bottom: 2rem;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
            <!--<h3 style="color: white; margin: 0; font-size: 1.2rem; font-weight: 600;">üìã Tareas sin fecha</h3>-->
            <button type="button" class="toggle-section-btn" onclick="toggleNoDateSection()" id="toggleNoDateBtn" title="Mostrar/Ocultar tareas sin fecha">
                <svg id="toggleNoDateIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" style="transition: transform 0.3s ease;">
                    <path d="M6 9l6 6 6-6"/>
                        </svg>
                    </button>
        </div>
        <div class="tasks-slider" id="noDateSlider" style="display: block;">
            <div class="slider-container">
                <div class="slider-track">
                    {% for task in tasks_without_date %}
                    <div class="task-card-slide" draggable="true" data-task-id="{{ task.id }}" data-task-title="{{ task.title|e }}">
                        {% include 'task_card.html' %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            <button class="slider-btn slider-btn-prev" onclick="scrollSlider(this, 'prev')">‚Äπ</button>
            <button class="slider-btn slider-btn-next" onclick="scrollSlider(this, 'next')">‚Ä∫</button>
        </div>
    </div>
    <div id="noDateDivider" style="border-bottom: 2px solid rgba(255, 255, 255, 0.2); margin: 2rem 0; width: 100%;"></div>
    {% endif %}
    
    {% if view_mode == 'calendar' %}
    <!-- Vista de calendario semanal -->
    <div class="calendar-view">
        <div class="weekly-calendar">
            <!-- Flecha izquierda para retroceder semana -->
            <button type="button" class="calendar-arrow calendar-arrow-left" onclick="navegarSemana({{ week_offset - 1 }})" title="Semana anterior">
                ‚Üê
            </button>
            {% set week_days = [
                ('Lunes', 'Monday'),
                ('Martes', 'Tuesday'),
                ('Mi√©rcoles', 'Wednesday'),
                ('Jueves', 'Thursday'),
                ('Viernes', 'Friday'),
                ('S√°bado', 'Saturday'),
                ('Domingo', 'Sunday')
            ] %}
            {% for day_name, day_key in week_days %}
            <div class="calendar-day {% if day_key == 'Saturday' or day_key == 'Sunday' %}calendar-day-weekend{% endif %}" 
                 data-day-key="{{ day_key }}"
                 {% if week_dates and week_dates.get(day_key) %}data-day-date="{{ week_dates[day_key].strftime('%Y-%m-%d') }}"{% endif %}>
                <div class="calendar-day-header">
                    <h4>{{ day_name }}</h4>
                    {% if week_dates and week_dates.get(day_key) %}
                        <div class="calendar-day-date">{{ week_dates[day_key].strftime('%d/%m/%Y') }}</div>
                    {% endif %}
                </div>
                <div class="calendar-day-tasks">
                    {% if tasks_by_weekday and tasks_by_weekday.get(day_key) %}
                        {% for task in tasks_by_weekday[day_key] %}
                            <div class="calendar-task-item" onclick="openEditTaskModal({{ task.id }})" title="Haz clic para editar">
                                <div class="calendar-task-title">{{ task.title }}</div>
                                {% if task.client_name_raw %}
                                <div class="calendar-task-client">{{ task.client_name_raw }}</div>
                                {% endif %}
                                <div class="calendar-task-meta">
                                    <span class="priority-badge priority-{{ task.priority }}">{{ task.priority }}</span>
                                    {% if task.category %}
                                    {% set category_obj = categories|selectattr('name', 'equalto', task.category)|first %}
                                    {% if category_obj %}
                                    <span class="category-badge category-{{ task.category }}" style="background: {{ category_obj.color }};">
                                        {{ category_obj.icon }} {{ category_obj.display_name or category_obj.name }}
                                    </span>
                                    {% else %}
                                    <span class="category-badge category-{{ task.category }}">{{ task.category }}</span>
                                    {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            <!-- Flecha derecha para avanzar semana -->
            <button type="button" class="calendar-arrow calendar-arrow-right" onclick="navegarSemana({{ week_offset + 1 }})" title="Semana siguiente">
                ‚Üí
            </button>
            {% if week_offset != 0 %}
            <!-- Bot√≥n para volver a semana actual -->
            <button type="button" class="calendar-arrow calendar-arrow-center" onclick="navegarSemana(0)" title="Semana actual">
                üìÖ
            </button>
            {% endif %}
        </div>
    </div>
    {% else %}
    <!-- Vista de lista -->
    <!-- Grid para tareas con fecha -->
    {% if tasks_with_date %}
    <div class="with-date-section">
        <h3 style="color: white; margin-bottom: 1rem; font-size: 1.3rem; font-weight: 600;">üìÖ Tareas con fecha</h3>
        <div class="tasks-grid">
            {% for task in tasks_with_date %}
                {% include 'task_card.html' %}
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    {% if not tasks_with_date and not tasks_without_date %}
    <div class="empty-state">
        <div class="empty-state-icon">üì≠</div>
        <h3>No hay tareas</h3>
        <p>No se encontraron tareas con los filtros seleccionados.</p>
    </div>
    {% endif %}
    {% endif %}
</div>

<!-- Modal para im√°genes -->
<div id="imagesModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 90%; max-height: 90vh;">
        <span class="close" onclick="closeImagesModal()">&times;</span>
        <h3 style="margin-top: 0;">üì∑ Im√°genes adjuntas</h3>
        <div id="imagesContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem; max-height: 70vh; overflow-y: auto;">
            <!-- Las im√°genes se cargar√°n aqu√≠ -->
        </div>
    </div>
</div>

<!-- Modal para editar tarea -->
<div id="editTaskModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="closeEditTaskModal()">&times;</span>
        <h3 style="margin-top: 0;">‚úèÔ∏è Editar Tarea</h3>
        
        <form id="editTaskForm" onsubmit="saveTaskEdit(event)">
            <input type="hidden" id="editTaskId" name="task_id">
            
            <div class="form-group" style="margin-bottom: 1rem;">
                <label for="editTitle" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">T√≠tulo:</label>
                <input type="text" id="editTitle" name="title" required style="width: 100%; padding: 0.75rem; border: 1.5px solid #e0e0e0; border-radius: 6px; font-size: 1rem;">
            </div>
            
            <div class="form-group" style="margin-bottom: 1rem;">
                <label for="editDescription" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Descripci√≥n:</label>
                <textarea id="editDescription" name="description" rows="4" style="width: 100%; padding: 0.75rem; border: 1.5px solid #e0e0e0; border-radius: 6px; font-size: 0.9rem; font-family: inherit; resize: vertical;"></textarea>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div class="form-group">
                    <label for="editStatus" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Estado:</label>
                    <select id="editStatus" name="status" required style="width: 100%; padding: 0.75rem; border: 1.5px solid #e0e0e0; border-radius: 6px; font-size: 1rem;">
                        <option value="open">üü¶ Abierta</option>
                        <option value="completed">‚úÖ Completada</option>
                        <option value="cancelled">‚ùå Cancelada</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="editPriority" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Prioridad:</label>
                    <select id="editPriority" name="priority" required style="width: 100%; padding: 0.75rem; border: 1.5px solid #e0e0e0; border-radius: 6px; font-size: 1rem;">
                        <option value="normal">üü° Normal</option>
                        <option value="urgent">üî¥ Urgente</option>
                    </select>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div class="form-group">
                    <label for="editTaskDate" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Fecha:</label>
                    <input type="date" id="editTaskDate" name="task_date" style="width: 100%; padding: 0.75rem; border: 1.5px solid #e0e0e0; border-radius: 6px; font-size: 1rem;">
                </div>
                
                <div class="form-group">
                    <label for="editCategory" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Categor√≠a:</label>
                    <select id="editCategory" name="category" style="width: 100%; padding: 0.75rem; border: 1.5px solid #e0e0e0; border-radius: 6px; font-size: 1rem;">
                        <option value="">Sin categor√≠a</option>
                        {% for cat in categories %}
                        <option value="{{ cat.name }}">{{ cat.icon }} {{ cat.display_name or cat.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="form-group" style="margin-bottom: 1rem;">
                <label for="editAmpliacion" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Ampliaci√≥n:</label>
                <textarea id="editAmpliacion" name="ampliacion" rows="3" style="width: 100%; padding: 0.75rem; border: 1.5px solid #e0e0e0; border-radius: 6px; font-size: 0.9rem; font-family: inherit; resize: vertical;"></textarea>
            </div>
            
            <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button type="button" class="btn btn-secondary" onclick="closeEditTaskModal()">Cancelar</button>
                <button type="submit" class="btn btn-primary" id="saveTaskButton">üíæ Guardar Cambios</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal para ampliar tarea -->
<div id="ampliarModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
        <span class="close" onclick="closeAmpliarModal()">&times;</span>
        <h3 style="margin-top: 0;">üìù Ampliar Tarea</h3>
        
        <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #4285F4;">
            <strong style="color: #4285F4; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">üìã Tarea:</strong>
            <p id="ampliarModalTaskTitle" style="margin: 0; color: #495057; font-size: 1rem; line-height: 1.5;"></p>
        </div>
        
        <!-- Historial de ampliaciones -->
        <div id="ampliarHistory" style="margin-bottom: 1.5rem; max-height: 300px; overflow-y: auto; padding: 1rem; background: #f0f7ff; border-radius: 8px; border: 1px solid #e0e0e0;">
            <strong style="color: #4285F4; font-size: 0.9rem; display: block; margin-bottom: 0.75rem;">üìú Historial de ampliaciones:</strong>
            <div id="ampliarHistoryContent" style="color: #495057; font-size: 0.9rem;">
                <p style="margin: 0; color: #6c757d; font-style: italic;">Cargando historial...</p>
            </div>
        </div>
        
        <form id="ampliarForm" onsubmit="saveAmpliacion(event)">
            <input type="hidden" id="ampliarTaskId" name="task_id">
            <div class="form-group">
                <label for="ampliarText" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">Nueva ampliaci√≥n:</label>
                <textarea id="ampliarText" name="ampliacion" rows="4" required style="width: 100%; padding: 0.75rem; border: 1.5px solid #e0e0e0; border-radius: 6px; font-size: 0.9rem; font-family: inherit; resize: vertical;"></textarea>
            </div>
            <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
                <button type="button" class="btn btn-secondary" onclick="closeAmpliarModal()">Cancelar</button>
                <button type="submit" class="btn btn-primary">üíæ Guardar Ampliaci√≥n</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal para soluci√≥n -->
<div id="solutionModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="closeSolutionModal()">&times;</span>
        <h3 style="margin-top: 0;">üí° A√±adir/Editar Soluci√≥n</h3>
        
        <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #1e3a5f;">
            <strong style="color: #1e3a5f; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">üìã Tarea:</strong>
            <p id="modalTaskTitle" style="margin: 0; color: #495057; font-size: 1rem; line-height: 1.5;"></p>
        </div>
        
        <form method="POST" action="" id="solutionForm">
            <div class="form-group">
                <label for="solution">Soluci√≥n/Resoluci√≥n:</label>
                <textarea id="solution" name="solution" rows="6" style="width: 100%; padding: 0.5rem; border: 1.5px solid #e0e0e0; border-radius: 6px; font-size: 0.9rem; font-family: inherit; resize: vertical;"></textarea>
            </div>
            <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
                <button type="button" class="btn btn-secondary" onclick="closeSolutionModal()">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar</button>
            </div>
        </form>
    </div>
</div>

<script>
// Funciones para el modal de ampliar
async function openAmpliarModalFromButton(button) {
    const taskId = button.getAttribute('data-task-id');
    const taskTitle = button.getAttribute('data-task-title');
    await openAmpliarModal(taskId, taskTitle);
}

async function openAmpliarModal(taskId, taskTitle) {
    const modal = document.getElementById('ampliarModal');
    const titleElement = document.getElementById('ampliarModalTaskTitle');
    const historyContent = document.getElementById('ampliarHistoryContent');
    const form = document.getElementById('ampliarForm');
    
    titleElement.textContent = taskTitle;
    document.getElementById('ampliarTaskId').value = taskId;
    document.getElementById('ampliarText').value = '';
    
    // Cargar historial
    historyContent.innerHTML = '<p style="margin: 0; color: #6c757d; font-style: italic;">Cargando historial...</p>';
    
    try {
        const response = await fetch(`/admin/tasks/${taskId}/ampliaciones-history`);
        const data = await response.json();
        
        if (response.ok && data.success) {
            const history = data.history;
            if (history && history.length > 0) {
                let historyHtml = '';
                history.forEach(item => {
                    const date = new Date(item.created_at);
                    const dateStr = date.toLocaleString('es-ES', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    historyHtml += `
                        <div style="margin-bottom: 1rem; padding: 0.75rem; background: white; border-radius: 6px; border-left: 3px solid #4285F4;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <strong style="color: #4285F4; font-size: 0.85rem;">${item.user_name}</strong>
                                <span style="color: #6c757d; font-size: 0.8rem;">${dateStr}</span>
                            </div>
                            <p style="margin: 0; color: #495057; font-size: 0.9rem; white-space: pre-wrap;">${item.ampliacion_text}</p>
                        </div>
                    `;
                });
                historyContent.innerHTML = historyHtml;
            } else {
                historyContent.innerHTML = '<p style="margin: 0; color: #6c757d; font-style: italic;">No hay ampliaciones anteriores.</p>';
            }
        } else {
            historyContent.innerHTML = '<p style="margin: 0; color: #dc3545; font-style: italic;">Error al cargar el historial.</p>';
        }
    } catch (error) {
        historyContent.innerHTML = '<p style="margin: 0; color: #dc3545; font-style: italic;">Error al cargar el historial.</p>';
    }
    
    modal.style.display = 'flex';
}

function closeAmpliarModal() {
    document.getElementById('ampliarModal').style.display = 'none';
    document.getElementById('ampliarForm').reset();
}

async function saveAmpliacion(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    const taskId = formData.get('task_id');
    const ampliacionText = formData.get('ampliacion').trim();
    
    if (!ampliacionText) {
        alert('La ampliaci√≥n no puede estar vac√≠a');
        return;
    }
    
    try {
        const response = await fetch(`/admin/tasks/${taskId}/ampliar`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                ampliacion: ampliacionText
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            alert('‚úÖ Ampliaci√≥n guardada correctamente');
            closeAmpliarModal();
            // Recargar la p√°gina para ver los cambios
            window.location.reload();
        } else {
            alert('Error al guardar la ampliaci√≥n: ' + (data.error || 'Error desconocido'));
        }
    } catch (error) {
        alert('Error al guardar la ampliaci√≥n: ' + error.message);
    }
}

function openSolutionModalFromButton(button) {
    const taskId = button.getAttribute('data-task-id');
    const taskTitle = button.getAttribute('data-task-title');
    const solutionJson = button.getAttribute('data-solution');
    let currentSolution = '';
    
    if (solutionJson) {
        try {
            currentSolution = JSON.parse(solutionJson);
        } catch (e) {
            currentSolution = solutionJson;
        }
    }
    
    openSolutionModal(taskId, taskTitle, currentSolution);
}

function openSolutionModal(taskId, taskTitle, currentSolution) {
    const modal = document.getElementById('solutionModal');
    const form = document.getElementById('solutionForm');
    const textarea = document.getElementById('solution');
    const titleElement = document.getElementById('modalTaskTitle');
    
    form.action = '/admin/tasks/' + taskId + '/solution';
    textarea.value = currentSolution || '';
    titleElement.textContent = taskTitle || 'Sin t√≠tulo';
    modal.style.display = 'flex';
}

function closeSolutionModal() {
    document.getElementById('solutionModal').style.display = 'none';
}

// Cerrar modal al hacer clic fuera
window.onclick = function(event) {
    const modal = document.getElementById('solutionModal');
    if (event.target == modal) {
        closeSolutionModal();
    }
    
    // Cerrar dropdowns de acciones al hacer clic fuera
    if (!event.target.closest('.dropdown-actions')) {
        document.querySelectorAll('.dropdown-menu').forEach(dropdown => {
            dropdown.classList.remove('show');
        });
    }
}

// Funciones para el slider de tareas sin fecha
function scrollSlider(button, direction) {
    const slider = button.closest('.tasks-slider');
    if (!slider) return;
    
    const sliderTrack = slider.querySelector('.slider-track');
    if (!sliderTrack) return;
    
    const firstSlide = sliderTrack.querySelector('.task-card-slide');
    if (!firstSlide) return;
    
    const slideWidth = firstSlide.offsetWidth + 16; // 16px de gap (1rem)
    const scrollAmount = direction === 'next' ? slideWidth : -slideWidth;
    
    sliderTrack.scrollBy({
        left: scrollAmount,
        behavior: 'smooth'
    });
}

// Funciones de acciones eliminadas - ahora los botones est√°n directamente visibles

function changeView(viewMode) {
    const url = new URL(window.location.href);
    url.searchParams.set('view_mode', viewMode);
    // Resetear semana a la actual cuando cambiamos de vista
    if (viewMode === 'calendar') {
        url.searchParams.set('week_offset', '0');
    }
    window.location.href = url.toString();
}

async function navegarSemana(weekOffset) {
    const calendarView = document.querySelector('.calendar-view');
    if (!calendarView) return;
    
    // Guardar posici√≥n del scroll relativa al calendario
    const calendarRect = calendarView.getBoundingClientRect();
    const scrollOffset = window.scrollY - calendarRect.top;
    
    // Deshabilitar botones durante la carga
    const arrows = calendarView.querySelectorAll('.calendar-arrow');
    arrows.forEach(arrow => {
        arrow.disabled = true;
        arrow.style.opacity = '0.5';
        arrow.style.cursor = 'wait';
    });
    
    // Mostrar indicador de carga sutil
    calendarView.style.transition = 'opacity 0.2s ease';
    calendarView.style.opacity = '0.7';
    
    try {
        // Construir URL con todos los par√°metros actuales
        const url = new URL(window.location.href);
        url.searchParams.set('week_offset', weekOffset);
        url.searchParams.set('view_mode', 'calendar');
        
        // Hacer petici√≥n AJAX
        const response = await fetch(url.toString());
        if (!response.ok) {
            throw new Error('Error en la respuesta del servidor');
        }
        
        const html = await response.text();
        
        // Crear un elemento temporal para parsear el HTML
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        
        // Extraer solo el contenido del calendario
        const newCalendarView = tempDiv.querySelector('.calendar-view');
        
        if (newCalendarView) {
            // Guardar la posici√≥n actual del scroll antes de reemplazar
            const currentScrollY = window.scrollY;
            
            // Reemplazar el contenido del calendario
            calendarView.innerHTML = newCalendarView.innerHTML;
            
            // Reinicializar drag and drop para los nuevos d√≠as del calendario
            const calendarDays = calendarView.querySelectorAll('.calendar-day[data-day-date]');
            calendarDays.forEach(day => {
                day.addEventListener('dragover', handleDragOver);
                day.addEventListener('dragenter', handleDragEnter);
                day.addEventListener('dragleave', handleDragLeave);
                day.addEventListener('drop', handleDrop);
            });
            
            // Esperar a que el navegador renderice el nuevo contenido
            requestAnimationFrame(() => {
                // Calcular la nueva posici√≥n del scroll
                const newCalendarRect = calendarView.getBoundingClientRect();
                const newScrollY = newCalendarRect.top + scrollOffset;
                
                // Restaurar posici√≥n del scroll sin animaci√≥n
                window.scrollTo({
                    top: newScrollY,
                    behavior: 'instant'
                });
                
                // Restaurar opacidad
                calendarView.style.opacity = '1';
            });
        }
    } catch (error) {
        console.error('Error al cargar la semana:', error);
        // En caso de error, recargar la p√°gina completa
        const url = new URL(window.location.href);
        url.searchParams.set('week_offset', weekOffset);
        url.searchParams.set('view_mode', 'calendar');
        window.location.href = url.toString();
    } finally {
        // Restaurar botones
        arrows.forEach(arrow => {
            arrow.disabled = false;
            arrow.style.opacity = '1';
            arrow.style.cursor = 'pointer';
        });
    }
}

function toggleNoDateSection() {
    const slider = document.getElementById('noDateSlider');
    const icon = document.getElementById('toggleNoDateIcon');
    const divider = document.getElementById('noDateDivider');
    
    if (slider.style.display === 'none') {
        slider.style.display = 'block';
        icon.style.transform = 'rotate(0deg)';
        if (divider) divider.style.display = 'block';
    } else {
        slider.style.display = 'none';
        icon.style.transform = 'rotate(180deg)';
        if (divider) divider.style.display = 'none';
    }
}

// Funcionalidad de Drag and Drop para tareas sin fecha
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar drag and drop para tareas sin fecha
    initDragAndDrop();
});

function initDragAndDrop() {
    // Hacer las tareas sin fecha arrastrables
    const taskCards = document.querySelectorAll('.task-card-slide[draggable="true"]');
    taskCards.forEach(card => {
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
    });
    
    // Hacer los d√≠as del calendario zonas de drop
    const calendarDays = document.querySelectorAll('.calendar-day[data-day-date]');
    calendarDays.forEach(day => {
        day.addEventListener('dragover', handleDragOver);
        day.addEventListener('dragenter', handleDragEnter);
        day.addEventListener('dragleave', handleDragLeave);
        day.addEventListener('drop', handleDrop);
    });
}

let draggedElement = null;
let draggedTaskId = null;

function handleDragStart(e) {
    draggedElement = this;
    draggedTaskId = this.getAttribute('data-task-id');
    const taskTitle = this.getAttribute('data-task-title');
    
    // A√±adir datos al evento de arrastre
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.outerHTML);
    e.dataTransfer.setData('task-id', draggedTaskId);
    
    // Estilo visual durante el arrastre
    this.style.opacity = '0.5';
    this.style.cursor = 'grabbing';
    
    // Crear imagen de arrastre personalizada
    const dragImage = this.cloneNode(true);
    dragImage.style.width = '200px';
    dragImage.style.opacity = '0.8';
    document.body.appendChild(dragImage);
    e.dataTransfer.setDragImage(dragImage, 0, 0);
    setTimeout(() => document.body.removeChild(dragImage), 0);
}

function handleDragEnd(e) {
    // Restaurar estilo
    if (draggedElement) {
        draggedElement.style.opacity = '1';
        draggedElement.style.cursor = 'grab';
    }
    
    // Limpiar estilos de todos los d√≠as
    document.querySelectorAll('.calendar-day').forEach(day => {
        day.classList.remove('drag-over');
    });
    
    draggedElement = null;
    draggedTaskId = null;
}

function handleDragOver(e) {
    if (e.preventDefault) {
        e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';
    return false;
}

function handleDragEnter(e) {
    this.classList.add('drag-over');
}

function handleDragLeave(e) {
    // Solo quitar la clase si realmente salimos del elemento (no de un hijo)
    if (!this.contains(e.relatedTarget)) {
        this.classList.remove('drag-over');
    }
}

async function handleDrop(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }
    
    this.classList.remove('drag-over');
    
    const taskId = e.dataTransfer.getData('task-id') || draggedTaskId;
    const dayDate = this.getAttribute('data-day-date');
    
    if (!taskId || !dayDate) {
        return false;
    }
    
    // Mostrar indicador de carga
    const dropZone = this.querySelector('.calendar-day-tasks');
    const loadingIndicator = document.createElement('div');
    loadingIndicator.className = 'drop-loading';
    loadingIndicator.innerHTML = '‚è≥ Asignando fecha...';
    dropZone.appendChild(loadingIndicator);
    
    try {
        // Actualizar la fecha de la tarea
        const response = await fetch(`/admin/tasks/${taskId}/set_date`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                task_date: dayDate
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            // Eliminar la tarea del slider de tareas sin fecha
            if (draggedElement) {
                draggedElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                draggedElement.style.opacity = '0';
                draggedElement.style.transform = 'scale(0.8)';
                setTimeout(() => {
                    draggedElement.remove();
                }, 300);
            }
            
            // Mostrar mensaje de √©xito
            loadingIndicator.innerHTML = '‚úÖ Fecha asignada';
            loadingIndicator.className = 'drop-success';
            
            // Recargar la p√°gina despu√©s de un breve delay para mostrar el cambio
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            throw new Error(data.error || 'Error al asignar fecha');
        }
    } catch (error) {
        console.error('Error al asignar fecha:', error);
        loadingIndicator.innerHTML = '‚ùå Error: ' + error.message;
        loadingIndicator.className = 'drop-error';
        setTimeout(() => {
            loadingIndicator.remove();
        }, 3000);
    }
    
    return false;
}

function openTaskImages(taskId, imagesJson) {
    const modal = document.getElementById('imagesModal');
    const container = document.getElementById('imagesContainer');
    
    // Parsear JSON si es string
    let images;
    if (typeof imagesJson === 'string') {
        try {
            images = JSON.parse(imagesJson);
        } catch (e) {
            console.error('Error parsing images JSON:', e);
            images = [];
        }
    } else {
        images = imagesJson;
    }
    
    // Limpiar contenedor
    container.innerHTML = '';
    
    if (!images || images.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 2rem;">No hay im√°genes disponibles.</p>';
        modal.style.display = 'flex';
        return;
    }
    
    // Crear elementos de imagen
    images.forEach(image => {
        const imageDiv = document.createElement('div');
        imageDiv.style.cssText = 'position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s ease;';
        imageDiv.onmouseenter = function() {
            this.style.transform = 'scale(1.05)';
        };
        imageDiv.onmouseleave = function() {
            this.style.transform = 'scale(1)';
        };
        
        const img = document.createElement('img');
        img.src = `/admin/tasks/${taskId}/images/${image.id}`;
        img.style.cssText = 'width: 100%; height: 200px; object-fit: cover; display: block;';
        img.onerror = function() {
            this.style.display = 'none';
            imageDiv.innerHTML = '<div style="width: 100%; height: 200px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; color: #6c757d;">Imagen no disponible</div>';
        };
        img.onclick = function(e) {
            e.stopPropagation();
            window.open(img.src, '_blank');
        };
        
        imageDiv.appendChild(img);
        container.appendChild(imageDiv);
    });
    
    modal.style.display = 'flex';
}

function closeImagesModal() {
    document.getElementById('imagesModal').style.display = 'none';
}

// Funciones para el men√∫ dock circular
function toggleDockMenu(button) {
    const dockItem = button.closest('.dock-item');
    const isActive = dockItem.classList.contains('active');

    document.querySelectorAll('.dock-item').forEach(item => item.classList.remove('active'));

    if (!isActive) {
        dockItem.classList.add('active');
    }
}


// Auto-enviar formulario al cambiar opciones
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('filterForm');
    const radioButtons = form.querySelectorAll('input[type="radio"]');
    const dateInput = form.querySelector('input[type="date"]');
    const searchInput = form.querySelector('input[name="search"]');
    
    // Auto-enviar al cambiar radios (con peque√±o delay para UX)
        radioButtons.forEach(radio => {
        radio.addEventListener('change', function() {
            // Cerrar el men√∫
            this.closest('.dock-item')?.classList.remove('active');
            
            // Restaurar scroll
            const scrollY = document.body.style.top;
            document.body.style.overflow = '';
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.width = '';
            if (scrollY) {
                window.scrollTo(0, parseInt(scrollY || '0') * -1);
            }
            
            // Enviar formulario despu√©s de un peque√±o delay
            setTimeout(() => {
                form.submit();
            }, 300);
        });
    });
    
    // Auto-enviar al cambiar fecha (con delay para que el usuario pueda seleccionar)
    if (dateInput) {
        let dateTimeout;
        dateInput.addEventListener('change', function() {
            clearTimeout(dateTimeout);
            this.closest('.dock-item')?.classList.remove('active');
            
            // Restaurar scroll
            const scrollY = document.body.style.top;
            document.body.style.overflow = '';
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.width = '';
            if (scrollY) {
                window.scrollTo(0, parseInt(scrollY || '0') * -1);
            }
            
            dateTimeout = setTimeout(() => {
                form.submit();
            }, 500);
        });
    }
    
    // Auto-enviar al escribir en b√∫squeda (con debounce)
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                if (this.value.length === 0 || this.value.length >= 3) {
                    this.closest('.dock-item')?.classList.remove('active');
                    
                    // Restaurar scroll
                    const scrollY = document.body.style.top;
                    document.body.style.overflow = '';
                    document.body.style.position = '';
                    document.body.style.top = '';
                    document.body.style.width = '';
                    if (scrollY) {
                        window.scrollTo(0, parseInt(scrollY || '0') * -1);
                    }
                    
                    form.submit();
                }
            }, 800);
        });
    }
});

// Cerrar men√∫s del dock al hacer clic fuera
document.addEventListener('click', function(event) {
    if (!event.target.closest('.dock-item')) {
        document.querySelectorAll('.dock-item').forEach(item => {
            item.classList.remove('active');
        });
        // Restaurar scroll cuando se cierra el men√∫
        const scrollY = document.body.style.top;
        document.body.style.overflow = '';
        document.body.style.position = '';
        document.body.style.top = '';
        document.body.style.width = '';
        if (scrollY) {
            window.scrollTo(0, parseInt(scrollY || '0') * -1);
        }
    }
});

// Cerrar modal de im√°genes al hacer clic fuera
window.onclick = function(event) {
    const solutionModal = document.getElementById('solutionModal');
    const imagesModal = document.getElementById('imagesModal');
    
    if (event.target == solutionModal) {
        closeSolutionModal();
    }
    
    if (event.target == imagesModal) {
        closeImagesModal();
    }
    
    const ampliarModal = document.getElementById('ampliarModal');
    if (event.target == ampliarModal) {
        closeAmpliarModal();
    }
    
    // Cerrar dropdowns de acciones al hacer clic fuera
    if (!event.target.closest('.dropdown-actions')) {
        document.querySelectorAll('.dropdown-menu').forEach(dropdown => {
            dropdown.classList.remove('show');
        });
    }
}

// Funciones para el modal de edici√≥n de tarea
async function openEditTaskModal(taskId) {
    const modal = document.getElementById('editTaskModal');
    const form = document.getElementById('editTaskForm');
    const saveButton = document.getElementById('saveTaskButton');
    
    // Mostrar modal centrado
    modal.style.display = 'flex';
    
    // Deshabilitar bot√≥n mientras carga
    saveButton.disabled = true;
    saveButton.textContent = '‚è≥ Cargando...';
    
    try {
        // Obtener datos de la tarea
        const response = await fetch(`/admin/tasks/${taskId}/edit`);
        const task = await response.json();
        
        if (response.ok && task) {
            // Rellenar formulario
            document.getElementById('editTaskId').value = task.id;
            document.getElementById('editTitle').value = task.title || '';
            document.getElementById('editDescription').value = task.description || '';
            document.getElementById('editStatus').value = task.status || 'open';
            document.getElementById('editPriority').value = task.priority || 'normal';
            document.getElementById('editTaskDate').value = task.task_date ? task.task_date.split('T')[0] : '';
            document.getElementById('editCategory').value = task.category || '';
            document.getElementById('editAmpliacion').value = task.ampliacion || '';
            
            saveButton.disabled = false;
            saveButton.textContent = 'üíæ Guardar Cambios';
        } else {
            throw new Error(task.error || 'Error al cargar la tarea');
        }
    } catch (error) {
        alert('Error al cargar la tarea: ' + error.message);
        closeEditTaskModal();
    }
}

function closeEditTaskModal() {
    const modal = document.getElementById('editTaskModal');
    modal.style.display = 'none';
    document.getElementById('editTaskForm').reset();
}

async function saveTaskEdit(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    const taskId = formData.get('task_id');
    const saveButton = document.getElementById('saveTaskButton');
    
    // Convertir FormData a objeto
    const data = {
        title: formData.get('title'),
        description: formData.get('description') || null,
        status: formData.get('status'),
        priority: formData.get('priority'),
        task_date: formData.get('task_date') || null,
        category: formData.get('category') || null,
        ampliacion: formData.get('ampliacion') || null
    };
    
    // Limpiar valores vac√≠os
    Object.keys(data).forEach(key => {
        if (data[key] === '' || data[key] === null) {
            delete data[key];
        }
    });
    
    saveButton.disabled = true;
    saveButton.textContent = '‚è≥ Guardando...';
    
    try {
        const response = await fetch(`/admin/tasks/${taskId}/update`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            // Recargar la p√°gina para ver los cambios
            window.location.reload();
        } else {
            throw new Error(result.error || 'Error al guardar');
        }
    } catch (error) {
        alert('Error al guardar: ' + error.message);
        saveButton.disabled = false;
        saveButton.textContent = 'üíæ Guardar Cambios';
    }
}

// Cerrar modal al hacer clic fuera
const originalOnClick = window.onclick;
window.onclick = function(event) {
    if (originalOnClick) originalOnClick(event);
    const editModal = document.getElementById('editTaskModal');
    if (event.target == editModal) {
        closeEditTaskModal();
    }
}
</script>
{% endblock %}

