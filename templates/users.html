{% extends "base.html" %}

{% block title %}Usuarios - Agenda Telegram{% endblock %}

{% block content %}
<h2>üë• Gesti√≥n de Usuarios</h2>

<div class="create-form" style="margin-bottom: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px;">
    <h3>‚ûï Crear Nuevo Usuario</h3>
    <form id="createUserForm">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
            <div class="form-group">
                <label for="username">Usuario:</label>
                <input type="text" id="username" name="username" required>
            </div>
            <div class="form-group">
                <label for="password">Contrase√±a:</label>
                <input type="password" id="password" name="password" required>
            </div>
        </div>
        <div class="form-group" style="margin-bottom: 1rem;">
            <label for="full_name">Nombre Completo:</label>
            <input type="text" id="full_name" name="full_name" required>
        </div>
        <div class="form-group" style="margin-bottom: 1rem;">
            <label>Categor√≠as Permitidas:</label>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem; margin-top: 0.5rem;">
                {% for category in categories %}
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" name="categories" value="{{ category.name }}">
                    <span>{{ category.icon }} {{ category.display_name or category.name }}</span>
                </label>
                {% endfor %}
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Crear Usuario</button>
    </form>
</div>

<div class="users-list">
    <h3>Lista de Usuarios</h3>
    {% if users %}
    <table class="table" style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background: #f8f9fa;">
                <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #dee2e6;">Usuario</th>
                <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #dee2e6;">Nombre Completo</th>
                <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #dee2e6;">Tipo</th>
                <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #dee2e6;">Estado</th>
                <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #dee2e6;">Categor√≠as</th>
                <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid #dee2e6;">Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td style="padding: 0.75rem; border-bottom: 1px solid #dee2e6;">{{ user.username }}</td>
                <td style="padding: 0.75rem; border-bottom: 1px solid #dee2e6;">{{ user.full_name }}</td>
                <td style="padding: 0.75rem; border-bottom: 1px solid #dee2e6;">
                    {% if user.is_master %}
                        <span style="background: #ffc107; color: #000; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem;">üëë Maestro</span>
                    {% else %}
                        <span style="background: #6c757d; color: #fff; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem;">Usuario</span>
                    {% endif %}
                </td>
                <td style="padding: 0.75rem; border-bottom: 1px solid #dee2e6;">
                    {% if user.is_active %}
                        <span style="color: #28a745;">‚úì Activo</span>
                    {% else %}
                        <span style="color: #dc3545;">‚úó Inactivo</span>
                    {% endif %}
                </td>
                <td style="padding: 0.75rem; border-bottom: 1px solid #dee2e6;">
                    {% if user.is_master %}
                        <span style="color: #6c757d; font-style: italic;">Todas</span>
                    {% elif user.categories %}
                        {% for cat_name in user.categories %}
                            {% set cat = categories|selectattr('name', 'equalto', cat_name)|first %}
                            {% if cat %}
                                <span style="background: #e9ecef; padding: 0.25rem 0.5rem; border-radius: 4px; margin-right: 0.25rem; font-size: 0.85rem;">
                                    {{ cat.icon }} {{ cat.display_name or cat.name }}
                                </span>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <span style="color: #6c757d; font-style: italic;">Sin categor√≠as</span>
                    {% endif %}
                </td>
                <td style="padding: 0.75rem; border-bottom: 1px solid #dee2e6;">
                    {% if not user.is_master %}
                        <button type="button" class="btn btn-sm btn-secondary" onclick="openEditUserModal({{ user.id }})" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">‚úèÔ∏è Editar</button>
                        <button type="button" class="btn btn-sm btn-danger" onclick="deleteUser({{ user.id }})" style="padding: 0.25rem 0.5rem; font-size: 0.85rem;">üóëÔ∏è Eliminar</button>
                    {% else %}
                        <span style="color: #6c757d; font-style: italic;">-</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No hay usuarios registrados.</p>
    {% endif %}
</div>

<!-- Modal para editar usuario -->
<div id="editUserModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <span class="close" onclick="closeEditUserModal()" style="float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        <h3 style="margin-top: 0;">‚úèÔ∏è Editar Usuario</h3>
        <form id="editUserForm">
            <input type="hidden" id="editUserId" name="user_id">
            <div class="form-group">
                <label for="editUsername">Usuario:</label>
                <input type="text" id="editUsername" name="username" required>
            </div>
            <div class="form-group">
                <label for="editPassword">Nueva Contrase√±a (dejar vac√≠o para no cambiar):</label>
                <input type="password" id="editPassword" name="password">
            </div>
            <div class="form-group">
                <label for="editFullName">Nombre Completo:</label>
                <input type="text" id="editFullName" name="full_name" required>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="editIsActive" name="is_active">
                    Usuario activo
                </label>
            </div>
            <div class="form-group">
                <label>Categor√≠as Permitidas:</label>
                <div id="editCategoriesContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem; margin-top: 0.5rem;">
                    {% for category in categories %}
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" name="categories" value="{{ category.name }}" class="edit-category-checkbox">
                        <span>{{ category.icon }} {{ category.display_name or category.name }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
            <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button type="button" class="btn btn-secondary" onclick="closeEditUserModal()">Cancelar</button>
                <button type="submit" class="btn btn-primary" id="saveUserButton">üíæ Guardar Cambios</button>
            </div>
        </form>
    </div>
</div>

<script>
// Crear usuario
document.getElementById('createUserForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    try {
        const response = await fetch('/admin/users/create', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            alert('Usuario creado correctamente');
            window.location.reload();
        } else {
            alert('Error: ' + (result.error || 'Error desconocido'));
        }
    } catch (error) {
        alert('Error al crear usuario: ' + error.message);
    }
});

// Abrir modal de edici√≥n
async function openEditUserModal(userId) {
    const modal = document.getElementById('editUserModal');
    const saveButton = document.getElementById('saveUserButton');
    
    saveButton.disabled = true;
    saveButton.textContent = '‚è≥ Cargando...';
    
    try {
        // Obtener datos del usuario
        const response = await fetch(`/admin/users/${userId}`);
        const user = await response.json();
        
        if (response.ok && user) {
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUsername').value = user.username || '';
            document.getElementById('editFullName').value = user.full_name || '';
            document.getElementById('editIsActive').checked = user.is_active || false;
            
            // Marcar categor√≠as del usuario
            const checkboxes = document.querySelectorAll('.edit-category-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            
            if (user.categories) {
                user.categories.forEach(catName => {
                    const checkbox = document.querySelector(`.edit-category-checkbox[value="${catName}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            modal.style.display = 'block';
            saveButton.disabled = false;
            saveButton.textContent = 'üíæ Guardar Cambios';
        } else {
            throw new Error(user.error || 'Error al cargar el usuario');
        }
    } catch (error) {
        alert('Error al cargar el usuario: ' + error.message);
        closeEditUserModal();
    }
}

// Cerrar modal
function closeEditUserModal() {
    const modal = document.getElementById('editUserModal');
    modal.style.display = 'none';
    document.getElementById('editUserForm').reset();
}

// Guardar cambios de usuario
document.getElementById('editUserForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const userId = formData.get('user_id');
    const saveButton = document.getElementById('saveUserButton');
    
    saveButton.disabled = true;
    saveButton.textContent = '‚è≥ Guardando...';
    
    try {
        const response = await fetch(`/admin/users/${userId}/update`, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            alert('Usuario actualizado correctamente');
            window.location.reload();
        } else {
            alert('Error: ' + (result.error || 'Error desconocido'));
            saveButton.disabled = false;
            saveButton.textContent = 'üíæ Guardar Cambios';
        }
    } catch (error) {
        alert('Error al guardar: ' + error.message);
        saveButton.disabled = false;
        saveButton.textContent = 'üíæ Guardar Cambios';
    }
});

// Eliminar usuario
async function deleteUser(userId) {
    if (!confirm('¬øEst√°s seguro de que quieres eliminar este usuario?')) {
        return;
    }
    
    try {
        const response = await fetch(`/admin/users/${userId}/delete`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            alert('Usuario eliminado correctamente');
            window.location.reload();
        } else {
            alert('Error: ' + (result.error || 'Error desconocido'));
        }
    } catch (error) {
        alert('Error al eliminar usuario: ' + error.message);
    }
}

// Cerrar modal al hacer clic fuera
window.onclick = function(event) {
    const editModal = document.getElementById('editUserModal');
    if (event.target == editModal) {
        closeEditUserModal();
    }
}
</script>
{% endblock %}

