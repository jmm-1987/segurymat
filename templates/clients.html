{% extends "base.html" %}

{% block title %}Clientes - Agenda Telegram{% endblock %}

{% block content %}
<h2>Clientes</h2>

<div class="create-form">
    <h3>Crear Cliente</h3>
    <form method="POST" action="{{ url_for('create_client') }}">
        <div class="form-group">
            <label for="name">Nombre:</label>
            <input type="text" id="name" name="name" required>
        </div>
        <div class="form-group">
            <label for="aliases">Aliases (separados por comas):</label>
            <input type="text" id="aliases" name="aliases" placeholder="alias1, alias2, alias3">
        </div>
        <button type="submit" class="btn btn-primary">Crear</button>
    </form>
</div>

<div class="clients-list">
    {% if clients %}
    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Aliases</th>
                <th>Creado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for client in clients %}
            <tr>
                <td>{{ client.id }}</td>
                <td>{{ client.name }}</td>
                <td>
                    {% if client.aliases %}
                        {% set aliases_list = client.aliases|fromjson %}
                        {{ aliases_list|join(', ') }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>{{ client.created_at|format_date }}</td>
                <td>
                    <div class="dropdown-actions">
                        <button type="button" class="btn btn-small btn-primary dropdown-toggle" onclick="toggleClientActionsDropdown({{ client.id }})">
                            âš™ï¸ Acciones
                            <span class="dropdown-arrow">â–¼</span>
                        </button>
                        <div id="client-actions-dropdown-{{ client.id }}" class="dropdown-menu">
                            <button type="button" class="dropdown-item btn-secondary" onclick="editClient({{ client.id }}, '{{ client.name }}', '{{ client.aliases or '' }}'); closeClientActionsDropdown({{ client.id }});">
                                âœï¸ Editar
                            </button>
                            <form method="POST" action="{{ url_for('delete_client', client_id=client.id) }}" style="display: block;" onsubmit="closeClientActionsDropdown({{ client.id }}); return confirm('Â¿Eliminar este cliente?');">
                                <button type="submit" class="dropdown-item btn-danger">ğŸ—‘ï¸ Eliminar</button>
                            </form>
                        </div>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No hay clientes registrados.</p>
    {% endif %}
</div>

<!-- Modal de ediciÃ³n -->
<div id="editModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h3>Editar Cliente</h3>
        <form id="editForm" method="POST">
            <div class="form-group">
                <label for="edit_name">Nombre:</label>
                <input type="text" id="edit_name" name="name" required>
            </div>
            <div class="form-group">
                <label for="edit_aliases">Aliases (separados por comas):</label>
                <input type="text" id="edit_aliases" name="aliases">
            </div>
            <button type="submit" class="btn btn-primary">Guardar</button>
            <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancelar</button>
        </form>
    </div>
</div>

<script>
function editClient(id, name, aliases) {
    document.getElementById('edit_name').value = name;
    document.getElementById('edit_aliases').value = aliases ? JSON.parse(aliases).join(', ') : '';
    document.getElementById('editForm').action = '/admin/clients/' + id + '/edit';
    document.getElementById('editModal').style.display = 'block';
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
}

// Funciones para manejar el dropdown de acciones de clientes
function toggleClientActionsDropdown(clientId) {
    const dropdown = document.getElementById('client-actions-dropdown-' + clientId);
    const isOpen = dropdown.classList.contains('show');
    
    // Cerrar todos los demÃ¡s dropdowns
    document.querySelectorAll('.dropdown-menu').forEach(d => {
        d.classList.remove('show');
    });
    
    // Abrir/cerrar el dropdown actual
    if (!isOpen) {
        dropdown.classList.add('show');
    }
}

function closeClientActionsDropdown(clientId) {
    const dropdown = document.getElementById('client-actions-dropdown-' + clientId);
    dropdown.classList.remove('show');
}

// Cerrar dropdowns al hacer clic fuera
window.onclick = function(event) {
    if (!event.target.closest('.dropdown-actions')) {
        document.querySelectorAll('.dropdown-menu').forEach(dropdown => {
            dropdown.classList.remove('show');
        });
    }
}
</script>
{% endblock %}

